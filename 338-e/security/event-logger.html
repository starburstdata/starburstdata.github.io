

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.12. Event Logger &mdash; Starburst Enterprise Presto</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/starburst.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="Starburst Enterprise Presto" href="../index.html"/>
        <link rel="up" title="7. Security" href="../security.html"/>
        <link rel="next" title="7.13. Role Based Access Control" href="rbac.html"/>
        <link rel="prev" title="7.11. Query audit" href="audit.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Starburst Enterprise Presto
          

          
          </a>

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">2. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client.html">3. Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../aws.html">4. Amazon Web Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../k8s.html">5. Kubernetes with Helm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kubernetes.html">6. Kubernetes operator</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../security.html">7. Security</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="server.html">7.1. Coordinator Kerberos Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.html">7.2. CLI Kerberos Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="ldap.html">7.3. LDAP Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="password-file.html">7.4. Password File Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="user-mapping.html">7.5. User Mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="tls.html">7.6. Java Keystores and Truststores</a></li>
<li class="toctree-l2"><a class="reference internal" href="built-in-system-access-control.html">7.7. Built-in System Access Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="ldap-group-provider.html">7.8. LDAP group provider</a></li>
<li class="toctree-l2"><a class="reference internal" href="secrets.html">7.9. Secrets</a></li>
<li class="toctree-l2"><a class="reference internal" href="internal-communication.html">7.10. Secure Internal Communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="audit.html">7.11. Query audit</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">7.12. Event Logger</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installation-and-configuration">Installation and configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#logged-information">Logged information</a></li>
<li class="toctree-l3"><a class="reference internal" href="#analyzing-the-event-log">Analyzing the event log</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="rbac.html">7.13. Role Based Access Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="system-ranger.html">7.14. System level security with Apache Ranger</a></li>
<li class="toctree-l2"><a class="reference internal" href="hive-ranger.html">7.15. Hive level security with Apache Ranger</a></li>
<li class="toctree-l2"><a class="reference internal" href="hive-sentry.html">7.16. Hive level security with Apache Sentry</a></li>
<li class="toctree-l2"><a class="reference internal" href="impersonation.html">7.17. User Impersonation</a></li>
<li class="toctree-l2"><a class="reference internal" href="credential-passthrough.html">7.18. Kerberos Credential Passthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="okta-authentication.html">7.19. Okta authentication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../admin.html">8. Administration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimizer.html">9. Query Optimizer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../connector.html">10. Connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../functions.html">11. Functions and Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language.html">12. SQL Language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sql.html">13. SQL Statement Syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migration.html">14. Migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../develop.html">15. Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">16. Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release.html">17. Release Notes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../404.html">404 - Nothing to See Here</a></li>
</ul>

            
          

        </div>
        <div style="margin-top: 1em; margin-left: 2em;">
          Version <a href="../versions.html">338-e LTS and others</a>
          <br><br>
        <span>
  <select name="versions" id="versions" onChange="window.location.href=this.value">
    <option value="./">Choose another version</option>
    <option value="/356-e/">Latest LTS (356-e)</option>
    <option value="/350-e/">350-e LTS</option>
    <option value="/345-e/">345-e LTS</option>
    <option value="/338-e/">338-e LTS</option>
    <option value="/359-e/">Latest STS (359-e)</option>
    <option value="/358-e/">358-e STS</option>
  </select>
</span>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="https://www.starburstdata.com/">
          <img class="logo"style="background-color: transparent; border-radius: 0%; width: auto; height: auto ;padding: 0px;"
          src="../_static/img/starburst-darkbg.png"/></a>
        <span class="optional">
          <a href="../index.html">Starburst Enterprise Presto</a>
          <a href="../versions.html" style="font-size: small;margin-left: 0.5em;">338-e LTS and others</a>
          <a href="https://www.starburstdata.com/oreilly-presto-guide-download/?utm_campaign=O%27Reilly%20Presto%20Book&utm_source=starburst&utm_medium=docs">
            <img class="logo"style="background-color: transparent; border-radius: 0%; width: auto; height: auto ;padding: 0px; margin-left: 0.5em;"
          src="../_static/img/ptdg-banner.png"/></a>
          </span>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
        <li><a href="../security.html"><span class="section-number">7. </span>Security</a> &raquo;</li>
      
    <li><span class="section-number">7.12. </span>Event Logger</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="event-logger">
<h1><span class="section-number">7.12. </span>Event Logger<a class="headerlink" href="#event-logger" title="Permalink to this headline">#</a></h1>
<p>The event logger allows query completion events and all related information to
be logged into a PostgreSQL database.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#requirements" id="id1">Requirements</a></p></li>
<li><p><a class="reference internal" href="#installation-and-configuration" id="id2">Installation and configuration</a></p></li>
<li><p><a class="reference internal" href="#logged-information" id="id3">Logged information</a></p></li>
<li><p><a class="reference internal" href="#analyzing-the-event-log" id="id4">Analyzing the event log</a></p></li>
<li><p><a class="reference internal" href="#example" id="id5">Example</a></p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Event logger requires a valid <a class="reference internal" href="../installation/license-requirements.html"><span class="doc">Starburst Enterprise Presto license</span></a>.</p>
</div>
<div class="section" id="requirements">
<h2><a class="toc-backref" href="#id1">Requirements</a><a class="headerlink" href="#requirements" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>PostgreSQL database, version 9.6 or higher</p></li>
<li><p>Network connectivity between the coordinator and the PostgreSQL server</p></li>
<li><p><a class="reference external" href="https://jdbc.postgresql.org/">PostgreSQL JDBC driver JAR</a> copied into
<code class="docutils literal notranslate"><span class="pre">plugin/eventlistener</span></code> on all nodes</p></li>
</ul>
<p>Connectivity between the Presto and the PostgreSQL database can be verified
on the coordinator or worker.</p>
<p>You can use <code class="docutils literal notranslate"><span class="pre">ping</span></code> to verify the hostname:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ping postgresql.example.com
</pre></div>
</div>
<p>You can use <code class="docutils literal notranslate"><span class="pre">telnet</span></code> with the hostname and port of the database to confirm
PostgreSQL is listening on the configured port.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ telent postgresql.example.com:5432
</pre></div>
</div>
</div>
<div class="section" id="installation-and-configuration">
<h2><a class="toc-backref" href="#id2">Installation and configuration</a><a class="headerlink" href="#installation-and-configuration" title="Permalink to this headline">#</a></h2>
<p>The event logger is implemented as a <a class="reference internal" href="../develop/event-listener.html"><span class="doc">event listener implementation</span></a> and can be enabled by creating a configuration file
called <code class="docutils literal notranslate"><span class="pre">etc/event-listener.properties</span></code> on the coordinator and workers. The
name needs to be set to <code class="docutils literal notranslate"><span class="pre">event-logger</span></code>. The configuration includes the JDBC
connection URL with hostname, port and database name as well as username and
password for accessing the PostgreSQL database.</p>
<div class="highlight-properties notranslate"><div class="highlight"><pre><span></span><span class="na">event-listener.name</span><span class="o">=</span><span class="s">event-logger</span>
<span class="na">jdbc.url</span><span class="o">=</span><span class="s">jdbc:postgresql://postgresql.example.com:5432/public</span>
<span class="na">jdbc.user</span><span class="o">=</span><span class="s">test_psql</span>
<span class="na">jdbc.password</span><span class="o">=</span><span class="s">test12</span>
</pre></div>
</div>
<p>The user needs to have sufficient rights to create tables and insert data in the
configured schema.</p>
<p>The cluster must be restarted after creating configuration file. At first usage
the table <code class="docutils literal notranslate"><span class="pre">completed_queries</span></code> is automatically created in the PostgreSQL
database.</p>
<p>Once the table is created, logging is activated and running.</p>
</div>
<div class="section" id="logged-information">
<h2><a class="toc-backref" href="#id3">Logged information</a><a class="headerlink" href="#logged-information" title="Permalink to this headline">#</a></h2>
<p>For each completed query, a row is created in the <code class="docutils literal notranslate"><span class="pre">completed_queries</span></code> table.
It captures everything that Presto emits – query, user, metadata, stats,
performance related attributes, resource consumption, start time, end time, and
much more.</p>
<p>The following columns are populated with the relevant information:</p>
<ul class="simple">
<li><p>query_id</p></li>
<li><p>catalog</p></li>
<li><p>schema</p></li>
<li><p>principal</p></li>
<li><p>user_agent</p></li>
<li><p>client_info</p></li>
<li><p>source</p></li>
<li><p>environment</p></li>
<li><p>remote_client_address</p></li>
<li><p>server_version</p></li>
<li><p>usr</p></li>
<li><p>query_state</p></li>
<li><p>query</p></li>
<li><p>query_plan</p></li>
<li><p>total_rows</p></li>
<li><p>total_bytes</p></li>
<li><p>output_rows</p></li>
<li><p>output_bytes</p></li>
<li><p>written_rows</p></li>
<li><p>written_bytes</p></li>
<li><p>cpu_time_ms</p></li>
<li><p>wall_time_ms</p></li>
<li><p>queued_time_ms</p></li>
<li><p>peak_user_memory_bytes</p></li>
<li><p>peak_total_non_revocable_memory_bytes</p></li>
<li><p>peak_task_user_memory</p></li>
<li><p>peak_task_total_memory</p></li>
<li><p>physical_input_bytes</p></li>
<li><p>physical_input_rows</p></li>
<li><p>internal_network_bytes</p></li>
<li><p>internal_network_rows</p></li>
<li><p>cumulative_memory</p></li>
<li><p>completed_splits</p></li>
<li><p>plan_node_stats_and_costs</p></li>
<li><p>stage_gc_statistics</p></li>
<li><p>cpu_time_distribution</p></li>
<li><p>operator_summaries</p></li>
<li><p>resource_waiting_time</p></li>
<li><p>analysis_time</p></li>
<li><p>execution_time</p></li>
<li><p>create_time</p></li>
<li><p>end_time</p></li>
<li><p>accessed_metadata</p></li>
</ul>
</div>
<div class="section" id="analyzing-the-event-log">
<h2><a class="toc-backref" href="#id4">Analyzing the event log</a><a class="headerlink" href="#analyzing-the-event-log" title="Permalink to this headline">#</a></h2>
<p>To analyze and query the event log, you can create a catalog with the
<a class="reference internal" href="../connector/postgresql.html"><span class="doc">PostgreSQL connector</span></a> using the same JDBC
connection parameters. This allows you to use the Presto CLI, or any other
application connected to the catalog to create queries, dashboards, perform ad
hoc analysis and more.</p>
<p>Example use cases:</p>
<ul class="simple">
<li><p>measure query performance numbers and trends</p></li>
<li><p>understand impact of different cluster configurations</p></li>
<li><p>enable cluster workload management and resource consumption</p></li>
</ul>
</div>
<div class="section" id="example">
<h2><a class="toc-backref" href="#id5">Example</a><a class="headerlink" href="#example" title="Permalink to this headline">#</a></h2>
<p>Generate event logger data by running a query.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>presto&gt; SELECT nationkey, name, regionkey FROM tpch.sf1.nation LIMIT 5;
nationkey |   name    | regionkey
-----------+-----------+-----------
        0 | ALGERIA   |         0
        1 | ARGENTINA |         1
        2 | BRAZIL    |         1
        3 | CANADA    |         1
        4 | EGYPT     |         4
(5 rows)

Query 20200703_035704_00001_9n2pi, FINISHED, 1 node
Splits: 33 total, 33 done (100.00%)
1.80 [25 rows, 0B] [13 rows/s, 0B/s]
</pre></div>
</div>
<p>Event logger data is written to the <code class="docutils literal notranslate"><span class="pre">completed_queries</span></code> table in the
PostgreSQL database.</p>
<p>In the following example, the catalog file is named <code class="docutils literal notranslate"><span class="pre">postgresql.properties</span></code>
and the <code class="docutils literal notranslate"><span class="pre">public</span></code> schema contains the <code class="docutils literal notranslate"><span class="pre">completed_queries</span></code> table. The query_id
from the execution is used to locate the correct record. The output in the
following example has been trimmed.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>presto&gt; SELECT *
        FROM postgresql.public.completed_queries
        WHERE query_id = &#39;20200703_035704_00001_9n2pi&#39;;
-[ RECORD 1 ]-------------------------+---------------------------------------
query_id                              | 20200703_035704_00001_9n2pi
catalog                               | NULL
schema                                | NULL
principal                             | NULL
user_agent                            | StatementClientV1/334
client_info                           | NULL
source                                | presto-cli
environment                           | demo
remote_client_address                 | 127.0.0.1
server_version                        | 334-e
usr                                   | demo
query_state                           | FINISHED
query                                 | SELECT nationkey, name, regionkey FROM tpch.sf1.nation LIMIT 5
query_plan                            | Fragment 0 [SINGLE]
                                      |     CPU: 24.50ms, Scheduled: 117.15ms, Input: 5 rows (148B); per task: avg.: 5.00 std.dev.: 0.00, Output: 5 rows
                                      |     Output layout: [nationkey, name, regionkey]
                                      | ...
total_rows                            | 25
total_bytes                           | 0
output_rows                           | 5
output_bytes                          | 148
written_rows                          | 0
written_bytes                         | 0
cpu_time_ms                           | 1615
wall_time_ms                          | 2169
queued_time_ms                        | 10
peak_user_memory_bytes                | 0
peak_total_non_revocable_memory_bytes | 0
peak_task_user_memory                 | 0
peak_task_total_memory                | 0
physical_input_bytes                  | 0
physical_input_rows                   | 25
internal_network_bytes                | 202
internal_network_rows                 | 5
cumulative_memory                     | 0.0
completed_splits                      | 33
plan_node_stats_and_costs             | {&quot;stats&quot;:{},&quot;costs&quot;:{}}
stage_gc_statistics                   | [{&quot;stageId&quot;:0,&quot;tasks&quot;:1,&quot;fullGcTasks&quot;:0,...
cpu_time_distribution                 | [{&quot;stageId&quot;:0,&quot;tasks&quot;:1,&quot;p25&quot;:25,&quot;p50&quot;:25,...
operator_summaries                    | [{&quot;stageId&quot;:0,&quot;pipelineId&quot;:0,&quot;operatorId&quot;:0,..
resource_waiting_time                 | 165
analysis_time                         | 168
execution_time                        | 1993
create_time                           | 2020-07-03 03:59:54.543 UTC
end_time                              | 2020-07-03 03:59:56.712 UTC
accessed_metadata                     | [{&quot;catalogName&quot;:&quot;tpch&quot;,&quot;schema&quot;:&quot;sf1.0&quot;,&quot;table&quot;:&quot;nation&quot;,&quot;columns&quot;:[&quot;nationkey&quot;,&quot;regionkey&quot;,&quot;name&quot;]}]
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="rbac.html" style="box-shadow: none; border: none;" class="btn btn-neutral float-right" title="7.13. Role Based Access Control" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="audit.html" style="box-shadow: none; border: none;" class="btn btn-neutral" title="7.11. Query audit" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'338',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  false
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>

<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="000A2C">
  <script src="../../_static/javascripts/modernizr.js"></script>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CY10FQPGJS"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-CY10FQPGJS');
</script>
  
  
    <title>Routing rules &#8212; Starburst Enterprise</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=bbebba6e" />
    <link rel="stylesheet" type="text/css" href="../../_static/material.css?v=79c92029" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/algolia.css?v=0e0f969e" />
    <link rel="stylesheet" type="text/css" href="../../_static/starburst.css?v=c0e612e9" />
    <link rel="stylesheet" type="text/css" href="../../_static/search.css?v=87ff3654" />
    <link rel="stylesheet" type="text/css" href="../../_static/sidebar.css?v=84a9f4d7" />
    <script src="../../_static/documentation_options.js?v=a68ab161"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=e378d701"></script>
    <script src="../../_static/main.js?v=5bbdfc95"></script>
    <script src="../../_static/heap_analytics.js?v=eba036f6"></script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Security" href="security.html" />
    <link rel="prev" title="Routing Logic" href="routing-logic.html" />

  
   

<link href="https://fonts.googleapis.com/css2?family=Barlow&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" >


<!-- Always link to the latest version, as canonical -->
<link rel="canonical" href="https://docs.starburst.io/latest/admin/starburst-gateway/routing-rules.html">

  </head>
  <body dir=ltr
        data-md-color-primary= data-md-color-accent=>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#admin/starburst-gateway/routing-rules" tabindex="1" class="md-skip"> Skip to content </a>
  
<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://www.starburst.io" title="Starburst Enterprise"
          class="md-header-nav__button md-logo">
            <img src="../../_static/img/Starburst_Logo_White+Blue.svg"
              alt="Starburst Enterprise 475-e STS logo">
        </a>
      </div>
      <span class="header-divider"></span>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <a href="/starburst-enterprise/index.html"
          class="md-header-nav__topic">
          Documentation: Starburst Enterprise 475-e STS</a>
          <span class="md-header-nav__topic"> Routing rules </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        <div id="algolia-search">
  <div id="searchbox"></div>
  <div id="product-list">
    <h6 class="filter-label">Product:</h6>
  </div>
  <div id="versionsRefinementList" id="version-list" style="display:none"></div>
  <div id="hits"></div>
  <div id="stats"></div>
</div>
      </div>
      
      
  
  <div class="md-flex__cell md-flex__cell--shrink dropdown">
    <button class="dropdownbutton">Choose version</button>
    <div class="dropdown-content md-hero">
          <a title="Latest LTS (474-e)" href="/474-e/">Latest LTS (474-e)</a>
      
          <a title="468-e LTS" href="/468-e/">468-e LTS</a>
      
          <a title="462-e LTS" href="/462-e/">462-e LTS</a>
      
          <a title="453-e LTS" href="/453-e/">453-e LTS</a>
      
          <a title="Latest STS (472-e)" href="/472-e/">Latest STS (472-e)</a>
      
    </div>
  </div>
  

    </div>
  </nav>
</header>


  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="/introduction/index.html" class="md-tabs__link">Introduction</a></li>
            
            <li class="md-tabs__item"><a href="/clients/index.html" class="md-tabs__link">Clients</a></li>
            
            <li class="md-tabs__item"><a href="/starburst-galaxy/index.html" class="md-tabs__link">Starburst Galaxy</a></li>
            
            <li class="md-tabs__item"><a href="/starburst-enterprise/index.html" class="md-tabs__link">Starburst Enterprise</a></li>
            
            <li class="md-tabs__item"><a href="/resources.html" class="md-tabs__link">Resources</a></li>
          <li class="md-tabs__item"><a href="../../admin.html" class="md-tabs__link">Performance, logging, and governance features</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Starburst Gateway</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../index.html" title="Starburst Enterprise" class="md-nav__button md-logo">
      
        <img src="../../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../index.html"
       title="Starburst Enterprise">Starburst Enterprise 475-e STS</a>
  </label>
  
  
  <p class="caption" role="heading"><span class="caption-text">Get started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../get-started/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get-started/starburst-enterprise.html">What is Starburst Enterprise?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get-started/try/try-sep.html">Try Starburst Enterprise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../learn/index.html">Learn Starburst Enterprise</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../versions.html">Product versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.starburst.io/support.html">Get support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For all users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/sep-ui.html">Starburst Enterprise web UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client.html">Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-products.html">Data products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../insights.html">Insights</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Use SQL</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../language.html">SQL language</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql.html">SQL statement syntax</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">Functions and operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../udf.html">User-defined functions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For data engineers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../catalogs.html">Define catalogs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../object-storage.html">Object storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-engineering/materialized-views.html">Materialized views</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-engineering/data-maintenance.html">Data maintenance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../optimizer.html">Query optimizer</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Connect to data sources</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../connector.html">Connector overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../object-storage-connectors.html">Object storage connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../non-object-storage-connectors.html">Non-object storage connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community-connectors.html">Community-supported connectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../connector/starburst-connectors.html">Starburst connectors feature matrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data-engineering/cost-and-performance/index.html">Monitor and manage cost and performance</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">For platform administrators</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-topics.html">Administration topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../admin.html">Performance, logging, and governance features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../starburst-rest-api.html">Starburst Enterprise REST API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deploy in cloud ecosystems</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ecosystems/aws/index.html">AWS ecosystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecosystems/google/index.html">Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecosystems/microsoft/index.html">Microsoft Azure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ecosystems/redhat/index.html">Red Hat OpenShift</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SEP deployment mechanisms</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../license-requirements.html">Starburst Enterprise license</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../k8s.html">Deploy with Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../starburst-admin.html">Deploy with Starburst Admin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../aws.html">Deploy with CFT on AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Local installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../develop.html">Trino developer guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../appendix.html">Version-specific notices and information</a></li>
</ul>
  
  
</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">"Contents"</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#admin-starburst-gateway-routing-rules--page-root" class="md-nav__link">Routing rules</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#enabling-the-routing-rules-engine" class="md-nav__link">Enabling the routing rules engine</a>
        </li>
        <li class="md-nav__item"><a href="#configuring-api-requests-with-http-client-config" class="md-nav__link">Configuring API requests with HTTP client config</a>
        </li>
        <li class="md-nav__item"><a href="#use-an-external-service-for-routing-rules" class="md-nav__link">Use an external service for routing rules</a>
        </li>
        <li class="md-nav__item"><a href="#configure-routing-rules-with-a-file" class="md-nav__link">Configure routing rules with a file</a>
        </li>
        <li class="md-nav__item"><a href="#health-status" class="md-nav__link">Health status</a>
        </li>
        <li class="md-nav__item"><a href="#trinorequestuser" class="md-nav__link">TrinoRequestUser</a>
        </li>
        <li class="md-nav__item"><a href="#trinoqueryproperties" class="md-nav__link">TrinoQueryProperties</a>
        </li>
        <li class="md-nav__item"><a href="#configuration" class="md-nav__link">Configuration</a>
        </li>
        <li class="md-nav__item"><a href="#execution-of-rules" class="md-nav__link">Execution of rules</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#rule-priority" class="md-nav__link">Rule priority</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#passing-state" class="md-nav__link">Passing State</a>
        </li>
        <li class="md-nav__item"><a href="#if-statements-mvel-flow-control" class="md-nav__link">If statements (MVEL Flow Control)</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="routing-rules">
<h1 id="admin-starburst-gateway-routing-rules--page-root">Routing rules<a class="headerlink" href="#admin-starburst-gateway-routing-rules--page-root" title="Link to this heading">#</a></h1>
<p>Starburst Gateway includes a routing rules engine.</p>
<p>By default, Starburst Gateway reads the <code class="docutils literal notranslate"><span class="pre">X-Trino-Routing-Group</span></code> request header to
route requests. If this header is not specified, requests are sent to the
default routing group called <code class="docutils literal notranslate"><span class="pre">adhoc</span></code>.</p>
<p>The routing rules engine feature enables you to either write custom logic to
route requests based on the request info such as any of the <a class="reference external" href="https://trino.io/docs/current/develop/client-protocol.html#client-request-headers">request
headers</a>,
or set a URL address to make an HTTP POST request and route based on the
returned result.</p>
<p>Routing rules are defined in a configuration file or implemented in separate,
custom service application. The connection to the separate service is configured
as a URL. It can implement any dynamic rule changes or other behavior.</p>
<section id="enabling-the-routing-rules-engine">
<h2 id="enabling-the-routing-rules-engine">Enabling the routing rules engine<a class="headerlink" href="#enabling-the-routing-rules-engine" title="Link to this heading">#</a></h2>
<p>To enable the routing rules engine, find the following lines in
<code class="docutils literal notranslate"><span class="pre">config.yaml</span></code>:</p>
<ul class="simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">rulesEngineEnabled</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>, then <code class="docutils literal notranslate"><span class="pre">rulesType</span></code> as <code class="docutils literal notranslate"><span class="pre">FILE</span></code> or <code class="docutils literal notranslate"><span class="pre">EXTERNAL</span></code>.</p></li>
<li><p>If you set <code class="docutils literal notranslate"><span class="pre">rulesType:</span> <span class="pre">FILE</span></code>, then set <code class="docutils literal notranslate"><span class="pre">rulesConfigPath</span></code> to the path to your
rules config file.</p></li>
<li><p>The rules file will be re-read every minute by default. You may change this by setting
<code class="docutils literal notranslate"><span class="pre">rulesRefreshPeriod:</span> <span class="pre">Duration</span></code>, where duration is an airlift style Duration such as <code class="docutils literal notranslate"><span class="pre">30s</span></code>.</p></li>
<li><p>If you set <code class="docutils literal notranslate"><span class="pre">rulesType:</span> <span class="pre">EXTERNAL</span></code>, set <code class="docutils literal notranslate"><span class="pre">rulesExternalConfiguration</span></code> to the URL
of an external service for routing rules processing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rulesType</span></code> is by default <code class="docutils literal notranslate"><span class="pre">FILE</span></code> unless specified.</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">routingRules</span><span class="p">:</span>
<span class="w">    </span><span class="nt">rulesEngineEnabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">rulesType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FILE</span>
<span class="w">    </span><span class="nt">rulesConfigPath</span><span class="p">:</span><span class="w"> </span><span class="s">"app/config/routing_rules.yml"</span><span class="w"> </span><span class="c1"># replace with actual path to your rules config file</span>
<span class="w">    </span><span class="nt">rulesExternalConfiguration</span><span class="p">:</span>
<span class="w">        </span><span class="nt">urlPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://router.example.com/gateway-rules</span><span class="w"> </span><span class="c1"># replace with your own API path</span>
<span class="w">        </span><span class="nt">excludeHeaders</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'Authorization'</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'Accept-Encoding'</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Redirect URLs are not supported.</p></li>
<li><p>Optionally, add headers to the <code class="docutils literal notranslate"><span class="pre">excludeHeaders</span></code> list to exclude requests with
corresponding header values from being sent in the POST request.</p></li>
<li><p>Check headers to exclude when making API requests, specifics depend on the
network configuration.</p></li>
</ul>
<p>If there is error parsing the routing rules configuration file, an error is
logged, and requests are routed using the routing group header
<code class="docutils literal notranslate"><span class="pre">X-Trino-Routing-Group</span></code> as default.</p>
</section>
<section id="configuring-api-requests-with-http-client-config">
<h2 id="configuring-api-requests-with-http-client-config">Configuring API requests with HTTP client config<a class="headerlink" href="#configuring-api-requests-with-http-client-config" title="Link to this heading">#</a></h2>
<p>You can configure the HTTP client by adding the following configuration to
the <code class="docutils literal notranslate"><span class="pre">serverConfig:</span></code> section with the <code class="docutils literal notranslate"><span class="pre">router</span></code> prefix.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">serverConfig</span><span class="p">:</span>
<span class="w">    </span><span class="nt">router.http-client.request-timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1s</span>
</pre></div>
</div>
<p>Please refer to the <a class="reference external" href="https://trino.io/docs/current/admin/properties-http-client.html">Trino HTTP client properties</a>
documentation for more.</p>
</section>
<section id="use-an-external-service-for-routing-rules">
<h2 id="use-an-external-service-for-routing-rules">Use an external service for routing rules<a class="headerlink" href="#use-an-external-service-for-routing-rules" title="Link to this heading">#</a></h2>
<p>You can use an external service for processing your routing by setting the
<code class="docutils literal notranslate"><span class="pre">rulesType</span></code> to <code class="docutils literal notranslate"><span class="pre">EXTERNAL</span></code> and configuring the <code class="docutils literal notranslate"><span class="pre">rulesExternalConfiguration</span></code>.</p>
<p>Starburst Gateway then sends all headers, other than those specified in
<code class="docutils literal notranslate"><span class="pre">excludeHeaders</span></code>, as a map in the body of a POST request to the external
service. If <code class="docutils literal notranslate"><span class="pre">requestAnalyzerConfig.analyzeRequest</span></code> is set to <code class="docutils literal notranslate"><span class="pre">true</span></code>,
<code class="docutils literal notranslate"><span class="pre">TrinoRequestUser</span></code> and <code class="docutils literal notranslate"><span class="pre">TrinoQueryProperties</span></code> are also included.</p>
<p>Additionally, the following HTTP information is included:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">remoteUser</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">method</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requestURI</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">queryString</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">session</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">remoteAddr</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">remoteHost</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">parameterMap</span></code></p></li>
</ul>
<p>The external service can process the information in any way desired and must
return a result with the following criteria:</p>
<ul class="simple">
<li><p>Response status code of OK (200)</p></li>
<li><p>Message in JSON format</p></li>
<li><p>Only one group can be returned</p></li>
<li><p>If errors is not null, then query would route to default routing group adhoc</p></li>
</ul>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">"routingGroup"</span><span class="p">:</span><span class="w"> </span><span class="s2">"test-group"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">"Error1"</span><span class="p">,</span>
<span class="w">        </span><span class="s2">"Error2"</span><span class="p">,</span>
<span class="w">        </span><span class="s2">"Error3"</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="configure-routing-rules-with-a-file">
<h2 id="configure-routing-rules-with-a-file">Configure routing rules with a file<a class="headerlink" href="#configure-routing-rules-with-a-file" title="Link to this heading">#</a></h2>
<p>Rules consist of a name, description, condition, and list
of actions. If the condition of a particular rule evaluates to <code class="docutils literal notranslate"><span class="pre">true</span></code>, its
actions are fired. Rules are stored as a
<a class="reference external" href="https://www.yaml.info/learn/document.html">multi-document</a> YAML file.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"airflow"</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"if</span><span class="nv"> </span><span class="s">query</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">airflow,</span><span class="nv"> </span><span class="s">route</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">etl</span><span class="nv"> </span><span class="s">group"</span>
<span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">'request.getHeader("X-Trino-Source")</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"airflow"'</span>
<span class="nt">actions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'result.put("routingGroup",</span><span class="nv"> </span><span class="s">"etl")'</span>
<span class="nn">---</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"airflow</span><span class="nv"> </span><span class="s">special"</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"if</span><span class="nv"> </span><span class="s">query</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">airflow</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">special</span><span class="nv"> </span><span class="s">label,</span><span class="nv"> </span><span class="s">route</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">etl-special</span><span class="nv"> </span><span class="s">group"</span>
<span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">'request.getHeader("X-Trino-Source")</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"airflow"</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">request.getHeader("X-Trino-Client-Tags")</span><span class="nv"> </span><span class="s">contains</span><span class="nv"> </span><span class="s">"label=special"'</span>
<span class="nt">actions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'result.put("routingGroup",</span><span class="nv"> </span><span class="s">"etl-special")'</span>
</pre></div>
</div>
<p>Three objects are available by default. They are</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">request</span></code>, the incoming request as an <a class="reference external" href="https://docs.oracle.com/javaee/6/api/javax/servlet/http/HttpServletRequest.html">HttpServletRequest</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">state</span></code>, a <code class="docutils literal notranslate"><span class="pre">HashMap&lt;String,</span> <span class="pre">Object&gt;</span></code> that allows passing arbitrary state from one rule evaluation to the next</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">result</span></code>, a <code class="docutils literal notranslate"><span class="pre">HashMap&lt;String,</span> <span class="pre">String&gt;</span></code> that is used to return the result of rule evaluation to the engine</p></li>
</ul>
<p>In addition to the default objects, rules may optionally utilize
<a class="reference internal" href="#trinorequestuser">trinoRequestUser</a> and
<a class="reference internal" href="#trinoqueryproperties">trinoQueryProperties</a>
, which provide information about the user and query respectively.
You must include an action of the form <code class="docutils literal notranslate"><span class="pre">result.put(\"routingGroup\",</span> <span class="pre">\"foo\")</span></code>
to trigger routing of a request that satisfies the condition to the specific
routing group. Without this action, the default adhoc group is used and the
whole routing rule is redundant.</p>
<p>The condition and actions are written in <a class="reference external" href="http://mvel.documentnode.com/">MVEL</a>,
an expression language with Java-like syntax. Classes from <code class="docutils literal notranslate"><span class="pre">java.util</span></code>, data-type
classes from <code class="docutils literal notranslate"><span class="pre">java.lang</span></code> such as <code class="docutils literal notranslate"><span class="pre">Integer</span></code> and <code class="docutils literal notranslate"><span class="pre">String</span></code>, as well as <code class="docutils literal notranslate"><span class="pre">java.lang.Math</span></code>
and <code class="docutils literal notranslate"><span class="pre">java.lang.StrictMath</span></code> are available in rules. Rules may not use <code class="docutils literal notranslate"><span class="pre">java.lang.System</span></code>
and other classes that allow access the Java runtime and operating system.
In most cases, you can write
conditions and actions in Java syntax and expect it to work. One exception is
parametrized types. Exclude type parameters, for example to add a <code class="docutils literal notranslate"><span class="pre">HashSet</span></code> to the
<code class="docutils literal notranslate"><span class="pre">state</span></code> variable, use an action such as:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="nl">actions</span><span class="p">:</span>
<span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="o">|</span>
<span class="w">    </span><span class="n">state</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">"triggeredRules"</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">HashSet</span><span class="p">())</span>
</pre></div>
</div>
<p>This is equivalent to <code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">HashSet&lt;Object&gt;()</span></code>.</p>
<p>There are some
MVEL-specific operators. For example, instead of doing a null-check before
accessing the <code class="docutils literal notranslate"><span class="pre">String.contains</span></code> method like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">'request.getHeader("X-Trino-Client-Tags")</span><span class="nv"> </span><span class="s">!=</span><span class="nv"> </span><span class="s">null</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">request.getHeader("X-Trino-Client-Tags").contains("label=foo")'</span>
</pre></div>
</div>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">contains</span></code> operator</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">'request.getHeader("X-Trino-Client-Tags")</span><span class="nv"> </span><span class="s">contains</span><span class="nv"> </span><span class="s">"label=foo"'</span>
</pre></div>
</div>
<p>If no rules match, then the request is routed to the default <code class="docutils literal notranslate"><span class="pre">adhoc</span></code> routing
group.</p>
</section>
<section id="health-status">
<span id="gateway-healthstatus"></span><h2 id="health-status">Health status<a class="headerlink" href="#health-status" title="Link to this heading">#</a></h2>
<p>Starburst Gateway’s health status attempts to track the current state of the
configured clusters. The three possible states of these cluster are updated with
every healthcheck:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PENDING</span></code>: A cluster shows this state when it is still starting up. It
is treated as unhealthy by <code class="docutils literal notranslate"><span class="pre">RoutingManager</span></code>, and therefore requests are
not be routed to these clusters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HEALTHY</span></code>: A cluster shows this state when health checks report
the cluster as healthy and ready. <code class="docutils literal notranslate"><span class="pre">RoutingManager</span></code> only routes requests to
healthy clusters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UNHEALTHY</span></code>: A cluster shows this state when health checks report the
cluster as unhealthy. <code class="docutils literal notranslate"><span class="pre">RoutingManager</span></code>  does not route requests to unhealthy
clusters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code>: A cluster shows this state when you configure a non-SEP
cluster.</p></li>
</ul>
</section>
<section id="trinorequestuser">
<span id="id1"></span><h2 id="trinorequestuser">TrinoRequestUser<a class="headerlink" href="#trinorequestuser" title="Link to this heading">#</a></h2>
<p>The  <code class="docutils literal notranslate"><span class="pre">TrinoRequestUser</span></code> class attempts to extract user information from a
request, in the following order:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">X-Trino-User</span></code> header.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Authorization:</span> <span class="pre">Basic</span></code> header.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Authorization:</span> <span class="pre">Bearer</span></code> header. Requires configuring an OAuth2 User Info URL.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Trino-UI-Token</span></code> or <code class="docutils literal notranslate"><span class="pre">__Secure-Trino-ID-Token</span></code> cookie.</p></li>
</ol>
<p>Kerberos and Certificate authentication are not currently supported. If the
request contains the <code class="docutils literal notranslate"><span class="pre">Authorization:</span> <span class="pre">Bearer</span></code> header, an attempt is made to treat
the token as a JWT and deserialize it. If this is successful, the value of the
claim named in <code class="docutils literal notranslate"><span class="pre">requestAnalyzerConfig.tokenUserField</span></code> is used as the username.
By default, this is the <code class="docutils literal notranslate"><span class="pre">email</span></code> claim. If the token is not a valid JWT, and
<code class="docutils literal notranslate"><span class="pre">requestAnalyzerConfig.oauthTokenInfoUrl</span></code> is configured, then the token is
exchanged with the Info URL. Responses are cached for 10 minutes to avoid
triggering rate limits.</p>
<p>You may call <code class="docutils literal notranslate"><span class="pre">trinoRequestUser.getUser()</span></code> and <code class="docutils literal notranslate"><span class="pre">trinoRequestUser.getUserInfo()</span></code>
in your routing rules. If user information was not successfully extracted,
<code class="docutils literal notranslate"><span class="pre">trinoRequestUser.getUser()</span></code> returns an empty <code class="docutils literal notranslate"><span class="pre">Optional</span></code>.
<code class="docutils literal notranslate"><span class="pre">trinoRequestUser.getUserInfo()</span></code> returns an <code class="docutils literal notranslate"><span class="pre">Optional&lt;UserInfo&gt;</span></code>, with an
<a class="reference external" href="https://www.javadoc.io/doc/com.nimbusds/oauth2-oidc-sdk/5.34/com/nimbusds/openid/connect/sdk/claims/UserInfo.html">OpenID Connect UserInfo</a>
if a token is successfully exchanged with the <code class="docutils literal notranslate"><span class="pre">oauthTokenInfoUrl</span></code>, and an empty
<code class="docutils literal notranslate"><span class="pre">Optional</span></code> otherwise.</p>
<p><code class="docutils literal notranslate"><span class="pre">trinoRequestUser.userExistsAndEquals("usernameToTest")</span></code> can be used to check a
username against the extracted user. It returns <code class="docutils literal notranslate"><span class="pre">false</span></code> if a user has not been
extracted.</p>
<p>User extraction is only available if enabled by configuring
<code class="docutils literal notranslate"><span class="pre">requestAnalyzerConfig.analyzeRequest</span> <span class="pre">=</span> <span class="pre">True</span></code></p>
</section>
<section id="trinoqueryproperties">
<span id="id2"></span><h2 id="trinoqueryproperties">TrinoQueryProperties<a class="headerlink" href="#trinoqueryproperties" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">TrinoQueryProperties</span></code> class attempts to parse the body of a request to
determine the SQL statement and other information. Note that only a
syntactic analysis is performed.</p>
<p>If a query references a view, then that view is not expanded, and tables
referenced by the view are not recognized. Views and materialized views are
treated as tables and added to the list of tables in all contexts, including
statements such as <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">VIEW</span></code>.</p>
<p>A routing rule can call the following methods on the <code class="docutils literal notranslate"><span class="pre">trinoQueryProperties</span></code>
object:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">String</span> <span class="pre">errorMessage()</span></code>: the error message, only if there was any error while
creating the <code class="docutils literal notranslate"><span class="pre">trinoQueryProperties</span></code> object.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">boolean</span> <span class="pre">isNewQuerySubmission()</span></code>: boolean flag to indicate if the
request is a POST to the <code class="docutils literal notranslate"><span class="pre">v1/statement</span></code> query endpoint.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">String</span> <span class="pre">getQueryType()</span></code>: the class name of the <code class="docutils literal notranslate"><span class="pre">Statement</span></code>, e.g. <code class="docutils literal notranslate"><span class="pre">ShowCreate</span></code>.
Note that these are not mapped to the <code class="docutils literal notranslate"><span class="pre">ResourceGroup</span></code> query types. For a full
list of potential query types, see the classes in
<a class="reference external" href="https://github.com/trinodb/trino/blob/2a882933937427e28ea0a3906ab13a60bcb4faad/core/trino-main/src/main/java/io/trino/util/StatementUtils.java#L170">STATEMENT_QUERY_TYPES</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">String</span> <span class="pre">getResourceGroupQueryType()</span></code>: the Resource Group query type, for
example <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>, <code class="docutils literal notranslate"><span class="pre">DATA_DEFINITION</span></code>. For a full list see <a class="reference external" href="https://trino.io/docs/current/admin/resource-groups.html#selector-rules">queryType in
the Trino documentation</a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">String</span> <span class="pre">getDefaultCatalog()</span></code>: the default catalog, if set. It may or may not
be referenced in the actual SQL</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">String</span> <span class="pre">getDefaultSchema()</span></code>: the default schema, if set. It may or may not
be referenced in the actual SQL</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Set&lt;String&gt;</span> <span class="pre">getCatalogs()</span></code>: the set of catalogs used in the query. Includes
the default catalog if used by a non-fully qualified table reference</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Set&lt;String&gt;</span> <span class="pre">getSchemas()</span></code>: the set of schemas used in the query. Includes the
default schema if used by a non-fully qualified table reference</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Set&lt;String&gt;</span> <span class="pre">getCatalogSchemas()</span></code> the set of qualified schemas used in the
query, in the form <code class="docutils literal notranslate"><span class="pre">catalog.schema</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">boolean</span> <span class="pre">tablesContains(String</span> <span class="pre">testName)</span></code> returns true if the query contains a
reference to the table <code class="docutils literal notranslate"><span class="pre">testName</span></code>.<code class="docutils literal notranslate"><span class="pre">testName</span></code> should be fully qualified, for
example <code class="docutils literal notranslate"><span class="pre">testcat.testschema.testtable</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Set&lt;QualifiedName&gt;</span> <span class="pre">getTables()</span></code>: the set of tables used in the query. These
are fully qualified, any partially qualified table reference in the SQL
will be qualified by the default catalog and schema.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">String</span> <span class="pre">getBody()</span></code>: the raw request body</p></li>
</ul>
</section>
<section id="configuration">
<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">trinoQueryProperties</span></code>  are configured under the <code class="docutils literal notranslate"><span class="pre">requestAnalyzerConfig</span></code>
configuration node.</p>
<p><code class="docutils literal notranslate"><span class="pre">analyzeRequest</span></code>:</p>
<p>Set to <code class="docutils literal notranslate"><span class="pre">True</span></code> to make <code class="docutils literal notranslate"><span class="pre">trinoQueryProperties</span></code> and <code class="docutils literal notranslate"><span class="pre">trinoRequestUser</span></code> available.</p>
<p><code class="docutils literal notranslate"><span class="pre">maxBodySize</span></code>:</p>
<p>By default, the max body size is 1,000,000 characters. This can be modified by
configuring <code class="docutils literal notranslate"><span class="pre">maxBodySize</span></code>. If the request body is greater or equal to this
limit, Starburst Gateway does not process the query. A buffer of length
<code class="docutils literal notranslate"><span class="pre">maxBodySize</span></code> is allocated per query. Reduce this value if you observe
excessive garbage collection at runtime. <code class="docutils literal notranslate"><span class="pre">maxBodySize</span></code> cannot be set to values
larger than 2**31-1, the maximum size of a Java String.</p>
<p><code class="docutils literal notranslate"><span class="pre">isClientsUseV2Format</span></code>:</p>
<p>Some commercial extensions to Trino use the V2 Request Structure
<a class="reference external" href="https://github.com/trinodb/trino/wiki/Trino-v2-client-protocol#submit-a-query">V2 style request structure</a>.
Support for V2-style requests can be enabled by setting this property to <code class="docutils literal notranslate"><span class="pre">true</span></code>.
If you use a commercial version of Trino, ask your vendor how to set this
configuration.</p>
<p><code class="docutils literal notranslate"><span class="pre">tokenUserField</span></code>:</p>
<p>When extracting the user from a JWT token, this field is used as the username.
By default, the <code class="docutils literal notranslate"><span class="pre">email</span></code> claim is used.</p>
<p><code class="docutils literal notranslate"><span class="pre">oauthTokenInfoUrl</span></code>:</p>
<p>If configured, Starburst Gateway attempts to retrieve the user info by exchanging
potential authorization tokens with this URL. Responses are cached for 10
minutes to avoid triggering rate limits.</p>
</section>
<section id="execution-of-rules">
<h2 id="execution-of-rules">Execution of rules<a class="headerlink" href="#execution-of-rules" title="Link to this heading">#</a></h2>
<p>All rules whose conditions are satisfied fire. For example, in the “airflow”
and “airflow special” example rules from the following rule priority section, a
query with source <code class="docutils literal notranslate"><span class="pre">airflow</span></code> and label <code class="docutils literal notranslate"><span class="pre">special</span></code> satisfies both rules. The
<code class="docutils literal notranslate"><span class="pre">routingGroup</span></code> is set to <code class="docutils literal notranslate"><span class="pre">etl</span></code> and then to <code class="docutils literal notranslate"><span class="pre">etl-special</span></code> because of the order in
which the rules of defined. If you swap the order of the rules, then you get
<code class="docutils literal notranslate"><span class="pre">etl</span></code> instead.</p>
<p>You can avoid this ordering issue by writing atomic rules, so any query matches
exactly one rule. For example you can change the first rule to the following:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"airflow"</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"if</span><span class="nv"> </span><span class="s">query</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">airflow,</span><span class="nv"> </span><span class="s">route</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">etl</span><span class="nv"> </span><span class="s">group"</span>
<span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">'request.getHeader("X-Trino-Source")</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"airflow"</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">request.getHeader("X-Trino-Client-Tags")</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">null'</span>
<span class="nt">actions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'result.put("routingGroup",</span><span class="nv"> </span><span class="s">"etl")'</span>
<span class="nn">---</span>
</pre></div>
</div>
<p>This can difficult to maintain with more rules. To have better control over the
execution of rules, we can use rule priorities. Overall,
priorities and other constructs that MVEL support allows
you to express your routing logic.</p>
<section id="rule-priority">
<h3 id="rule-priority">Rule priority<a class="headerlink" href="#rule-priority" title="Link to this heading">#</a></h3>
<p>You can assign an integer value <code class="docutils literal notranslate"><span class="pre">priority</span></code> to a rule. The lower this integer is,
the earlier it fires. If the priority is not specified, the priority defaults to
<code class="docutils literal notranslate"><span class="pre">INT_MAX</span></code>. Following is an example with priorities:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"airflow"</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"if</span><span class="nv"> </span><span class="s">query</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">airflow,</span><span class="nv"> </span><span class="s">route</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">etl</span><span class="nv"> </span><span class="s">group"</span>
<span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">'request.getHeader("X-Trino-Source")</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"airflow"'</span>
<span class="nt">actions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'result.put("routingGroup",</span><span class="nv"> </span><span class="s">"etl")'</span>
<span class="nn">---</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"airflow</span><span class="nv"> </span><span class="s">special"</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"if</span><span class="nv"> </span><span class="s">query</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">airflow</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">special</span><span class="nv"> </span><span class="s">label,</span><span class="nv"> </span><span class="s">route</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">etl-special</span><span class="nv"> </span><span class="s">group"</span>
<span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">'request.getHeader("X-Trino-Source")</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">"airflow"</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">request.getHeader("X-Trino-Client-Tags")</span><span class="nv"> </span><span class="s">contains</span><span class="nv"> </span><span class="s">"label=special"'</span>
<span class="nt">actions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">'result.put("routingGroup",</span><span class="nv"> </span><span class="s">"etl-special")'</span>
</pre></div>
</div>
<p>Note that both rules still fire. The difference is that you are guaranteed
that the first rule (priority 0) is fired before the second rule (priority 1).
Thus <code class="docutils literal notranslate"><span class="pre">routingGroup</span></code> is set to <code class="docutils literal notranslate"><span class="pre">etl</span></code> and then to <code class="docutils literal notranslate"><span class="pre">etl-special</span></code>, so the
<code class="docutils literal notranslate"><span class="pre">routingGroup</span></code> is always <code class="docutils literal notranslate"><span class="pre">etl-special</span></code> in the end.</p>
<p>More specific rules must be set to a higher priority so they are evaluated last
to set a <code class="docutils literal notranslate"><span class="pre">routingGroup</span></code>.</p>
<section id="passing-state">
<h4 id="passing-state">Passing State<a class="headerlink" href="#passing-state" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">state</span></code> object may be used to pass information from one rule evaluation to
the next. This allows an author to avoid duplicating logic in multiple rules.
Priority should be used to ensure that <code class="docutils literal notranslate"><span class="pre">state</span></code> is updated before being used
in downstream rules. For example, the atomic rules may be re-implemented as</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"initialize</span><span class="nv"> </span><span class="s">state"</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"Add</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">state</span><span class="nv"> </span><span class="s">map</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">track</span><span class="nv"> </span><span class="s">rules</span><span class="nv"> </span><span class="s">that</span><span class="nv"> </span><span class="s">have</span><span class="nv"> </span><span class="s">evaluated</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">true"</span>
<span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">"true"</span>
<span class="nt">actions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">state.put("triggeredRules",new HashSet())</span>
<span class="w">  </span><span class="c1"># MVEL does not support type parameters! HashSet&lt;String&gt;() would result in an error.</span>
<span class="nn">---</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"airflow"</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"if</span><span class="nv"> </span><span class="s">query</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">airflow,</span><span class="nv"> </span><span class="s">route</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">etl</span><span class="nv"> </span><span class="s">group"</span>
<span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">  </span><span class="no">request.getHeader("X-Trino-Source") == "airflow"</span>
<span class="nt">actions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">result.put("routingGroup", "etl")</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">state.get("triggeredRules").add("airflow")</span>
<span class="nn">---</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"airflow</span><span class="nv"> </span><span class="s">special"</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"if</span><span class="nv"> </span><span class="s">query</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">airflow</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">special</span><span class="nv"> </span><span class="s">label,</span><span class="nv"> </span><span class="s">route</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">etl-special</span><span class="nv"> </span><span class="s">group"</span>
<span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">  </span><span class="no">state.get("triggeredRules").contains("airflow") &amp;&amp; request.getHeader("X-Trino-Client-Tags") contains "label=special"</span>
<span class="nt">actions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">    </span><span class="no">result.put("routingGroup", "etl-special")</span>
</pre></div>
</div>
</section>
<section id="if-statements-mvel-flow-control">
<h4 id="if-statements-mvel-flow-control">If statements (MVEL Flow Control)<a class="headerlink" href="#if-statements-mvel-flow-control" title="Link to this heading">#</a></h4>
<p>You can use MVEL support for <code class="docutils literal notranslate"><span class="pre">if</span></code> statements and other flow control. The following logic
in pseudocode:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>if source == "airflow":
  if clientTags["label"] == "foo":
    return "etl-foo"
  else if clientTags["label"] = "bar":
    return "etl-bar"
  else
    return "etl"
</pre></div>
</div>
<p>This logic Can be implemented with the following rules:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">"airflow</span><span class="nv"> </span><span class="s">rules"</span>
<span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"if</span><span class="nv"> </span><span class="s">query</span><span class="nv"> </span><span class="s">from</span><span class="nv"> </span><span class="s">airflow"</span>
<span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="s">"request.getHeader(\"X-Trino-Source\")</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">\"airflow\""</span>
<span class="nt">actions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"if</span><span class="nv"> </span><span class="s">(request.getHeader(\"X-Trino-Client-Tags\")</span><span class="nv"> </span><span class="s">contains</span><span class="nv"> </span><span class="s">\"label=foo\")</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">result.put(\"routingGroup\",</span><span class="nv"> </span><span class="s">\"etl-foo\")</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">    </span><span class="s">else</span><span class="nv"> </span><span class="s">if</span><span class="nv"> </span><span class="s">(request.getHeader(\"X-Trino-Client-Tags\")</span><span class="nv"> </span><span class="s">contains</span><span class="nv"> </span><span class="s">\"label=bar\")</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">result.put(\"routingGroup\",</span><span class="nv"> </span><span class="s">\"etl-bar\")</span>
<span class="w">    </span><span class="s">}</span>
<span class="w">    </span><span class="s">else</span><span class="nv"> </span><span class="s">{</span>
<span class="w">      </span><span class="s">result.put(\"routingGroup\",</span><span class="nv"> </span><span class="s">\"etl\")</span>
<span class="w">    </span><span class="s">}"</span>
</pre></div>
</div>
</section>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
<div class="md-grid md-main__inner" style="height: auto;">
  <div class="md-content">
    <div class="feedback-container md-content__inner md-typeset">
      <div class="feedback-thumbs">
        <p>Is the information on this page helpful?</p>
        <p class="feedback-option" title="yes">Yes</p>
        <p class="feedback-option" title="no">No</p>
      </div>
      <div class="feedback-message">
        <textarea class="feedback-body" placeholder="Additional feedback"></textarea>
        <button type="button" onclick="sendMessage()" class="feedback-button">Email</button>
        <a onclick="skip()" class="feedback-skip">Cancel</a>
      </div>
    </div>
  </div>
</div>

<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', '');
</script>
<script>
function feedback() {
  var feedbackValue = "";
  var feedbackThumbs = document.querySelector(".feedback-thumbs");
  var feedbackMessage = document.querySelector(".feedback-message");
  var initialFeedbackMessageContents = feedbackMessage.innerHTML;
  var feedbackAnswer = localStorage.getItem('feedback-answer-' + window.location.pathname);
  var options = Array.from(document.querySelectorAll(".feedback-option"));

  if (feedbackAnswer) {
    Object.keys(options).map(i => options[i].getAttribute('title') == JSON.parse(feedbackAnswer)
      ? options[i].classList.add('active')
      : null
    );
  }

  var clickFunction = function(event){
    var page = window.location.pathname;
    var value = event.currentTarget.getAttribute('title');
    var eventValue = value == 'yes' ? 1 : 0;

    if(!event.currentTarget.classList.contains('active')) {
      localStorage.setItem('feedback-answer-' + page, JSON.stringify(value == 'yes' ? 'yes' : 'no'));
      feedbackValue = value;

      gtag('event', 'feedback', {
        'event_category': 'Docs Feedback',
        'event_label': page,
        'event_value': eventValue,
      });

      Object.keys(options).map(i => options[i].classList.remove('active'));
      event.currentTarget.classList.add('active');

      feedbackThumbs.style.display = "none";
      feedbackMessage.style.display = "flex";
    };
  };

  skip = function() {
    feedbackMessage.style.display = "none";
    feedbackThumbs.style.display = "flex";
    feedbackMessage.innerHTML = initialFeedbackMessageContents;
  }

  sendMessage = function(){
    var feedbackBody = document.querySelector(".feedback-body").value;

    if (feedbackBody) {
      var message = "Page url: " + window.location.pathname + "\n\n"
        + "Feedback positive?: " + feedbackValue + "\n\n" +  "Feedback Message: " + feedbackBody;
      var link = "mailto:docs-feedback@starburst.io?subject=" + encodeURIComponent("Feedback")+"&body="
        + encodeURIComponent(message);

      window.location.href = link;
      feedbackMessage.innerHTML = "<p>Thank you!</p>";

      setTimeout(function(){
          skip();
      }, 5000);
    } else {
      if(!document.querySelector("#feedback-skip")) {
        var alertMessage = document.createElement("p");
        alertMessage.id = "feedback-skip";
        alertMessage.style.color = "red";
        alertMessage.style.position = "absolute";
        alertMessage.style.bottom = "-0.5rem";
        alertMessage.innerHTML = "Please provide a message.";
        feedbackMessage.appendChild(alertMessage);

        setTimeout(function(){
          alertMessage.remove();
        }, 3000);
      }
    }
  }

  Object.keys(options).map(i => options[i].addEventListener('click', clickFunction , false));
}

feedback();
</script>

  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="routing-logic.html" title="Routing Logic"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> "Previous" </span> Routing Logic </span>
              </div>
            </a>
          
          
            <a href="security.html" title="Security"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> "Next" </span> Security </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
        </div>
      </div>
    </div>
  </footer>
  <script src="../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
<!-- custom footer should go here in time -->
<div class="page-footer">
  <div class="container md-grid">
    <div class="row">
      <div class="col-md-3">
        <p style="font-weight:900">Resources</p>
        <ul>
          <li class="footer-item"><a href="https://docs.starburst.io/latest/index.html">Starburst Enterprise reference documentation</a></li>
          <li class="footer-item"><a href="/videos/index.html">Video library</a></li>
          <li class="footer-item"><a href="/glossary.html">Glossary</a></li>
          <li class="footer-item"><a href="https://www.starburst.io/info/oreilly-trino-guide/" target="_blank">Free O'Reilly book - Trino: The Definitive Guide</a></li>
          <li class="footer-item"><a href="https://trino.io/broadcast/" target="_blank">Trino Community Broadcast</a></li>
          <li class="footer-item"><a href="https://blog.starburstdata.com/" target="_blank">Starburst blog</a></li>
        </ul>
      </div>
      <div class="col-md-3">
        <p style="font-weight:900">Contact and more</p>
        <ul>
          <li class="footer-item"><a href="https://www.starburst.io" target="_blank">Starburst</a></li>
          <li class="footer-item"><a href="https://www.starburst.io/info/starburst-intro-and-demo/" target="_blank">Join our weekly demos</a></li>
          <li class="footer-item"><a href="https://www.starburst.io/#!" target="_blank">Start a trial</a></li>
          <li class="footer-item"><a href="/support.html" target="_blank">Get support</a></li>
          <li class="footer-item"><a href="https://www.starburst.io/contact/" target="_blank">Contact us</a></li>
        </ul>
      </div>
      <div class="col-md-3" style="text-align:right;">

        <a href="https://www.starburst.io/" target="_blank">
          <img src="../../_static/img/Starburst_Logo_White+Blue.svg" height="34"
            alt="Starburst Enterprise 475-e STS logo">
        </a>
        <li class="footer-item" style="padding-right:10px;">
          <a href="/disclaimers.html#copyright">Copyright © 2017-2025<br> Starburst Data</a>
        </li>
        <li class="footer-item" style="padding-right:10px;">
          <a href="/disclaimers.html#trademarks">Trademark information</a>
        </li>
      </div>
    </div>
  </div>
</div>
<script src="https://docs.starburst.io/475-e/_static/algolia.js"></script>
<script src="https://docs.starburst.io/475-e/_static/searchbox.js" data-versions="{'Latest LTS (474-e)': '/474-e/', '468-e LTS': '/468-e/', '462-e LTS': '/462-e/', '453-e LTS': '/453-e/', 'Latest STS (472-e)': '/472-e/'}"></script>
<script src="https://docs.starburst.io/475-e/_static/searchresults.js" data-versions="{'Latest LTS (474-e)': '/474-e/', '468-e LTS': '/468-e/', '462-e LTS': '/462-e/', '453-e LTS': '/453-e/', 'Latest STS (472-e)': '/472-e/'}"></script>
  </body>
</html>